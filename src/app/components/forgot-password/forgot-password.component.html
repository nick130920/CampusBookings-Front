<div class="min-h-screen bg-linear-to-br from-gray-100 to-amber-50 flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
    <!-- Header -->
    <div class="bg-primary p-6 text-center relative">
      <div class="absolute inset-0 bg-linear-to-r from-transparent via-white/10 to-transparent"></div>
      <div class="relative z-10">
        <div class="mb-4">
          <img 
            src="assets/images/usco-logo.png" 
            alt="Universidad Surcolombiana"
            class="mx-auto h-16 w-auto filter brightness-0 invert drop-shadow-lg"
            onerror="this.style.display='none'"
          >
        </div>
        <h1 class="text-lg font-bold text-white mb-2">RECUPERAR CONTRASEÑA</h1>
        <p class="text-xs text-amber-200">Universidad Surcolombiana</p>
      </div>
    </div>
    
    <div class="p-6">
      <!-- Paso 1: Solicitar email -->
      @if (step === 1) {
        <div class="text-center mb-6">
          <i class="pi pi-envelope text-4xl text-primary mb-4"></i>
          <h2 class="text-xl font-bold text-gray-800 mb-2">¿Olvidaste tu contraseña?</h2>
          <p class="text-sm text-gray-600">
            Ingresa tu correo electrónico y te enviaremos un código para restablecer tu contraseña.
          </p>
        </div>

        <form [formGroup]="emailForm" (ngSubmit)="onSendCode()" class="space-y-6">
          <div class="field">
            <p-floatlabel>
              <input 
                id="email"
                type="email"
                pInputText
                formControlName="email"
                class="w-full"
                [class.ng-invalid]="emailControl?.invalid && emailControl?.touched"
              />
              <label for="email">
                <i class="pi pi-envelope mr-2 text-primary"></i>
                Correo electrónico
              </label>
            </p-floatlabel>
            @if (emailControl?.invalid && emailControl?.touched) {
              <small class="p-error block mt-2">
                @if (emailControl?.hasError('required')) {
                  <span>El correo electrónico es requerido</span>
                }
                @if (emailControl?.hasError('email')) {
                  <span>Por favor ingresa un correo electrónico válido</span>
                }
              </small>
            }
          </div>
          <div class="flex justify-center">
            <p-button
              type="submit"
              [disabled]="emailForm.invalid || isLoading"
              [loading]="isLoading"
              label="Enviar código"
              icon="pi pi-send">
            </p-button>
          </div>
        </form>
      }

      <!-- Paso 2: Ingresar código de verificación -->
      @if (step === 2) {
        <div class="text-center mb-6">
          <i class="pi pi-shield text-4xl text-primary mb-4"></i>
          <h2 class="text-xl font-bold text-gray-800 mb-2">Código de verificación</h2>
          <p class="text-sm text-gray-600 mb-4">
            Hemos enviado un código de 6 dígitos a <strong>{{ maskedEmail }}</strong>
          </p>
        </div>

        <form [formGroup]="codeForm" (ngSubmit)="onVerifyCode()" class="space-y-6">
          <div class="field">
            <label class="block text-sm font-medium mb-3 text-center" style="color: var(--p-surface-950)">
              <i class="pi pi-key mr-2 text-primary"></i>
              Ingresa el código de verificación
            </label>
            
            <div class="flex justify-center">
              <p-inputotp 
                formControlName="code"
                [length]="6"
                [integerOnly]="true"
                [invalid]="codeControl?.invalid && codeControl?.touched">
                <ng-template #input let-token let-events="events" let-index="index">
                  <input 
                    type="text" 
                    [maxLength]="1" 
                    (input)="events.input($event)" 
                    (keydown)="events.keydown($event)" 
                    [attr.value]="token" 
                    class="w-12 h-12 text-center text-xl font-semibold border-2 rounded-lg focus:border-primary focus:outline-none transition-colors"
                    style="border-color: var(--p-surface-300); color: var(--p-surface-950)"
                    [style.border-color]="codeControl?.invalid && codeControl?.touched ? 'var(--p-danger-color)' : 'var(--p-surface-300)'"
                  />
                  @if (index === 2) {
                    <div class="px-2">
                      <i class="pi pi-minus text-primary"></i>
                    </div>
                  }
                </ng-template>
              </p-inputotp>
            </div>
            
            @if (codeControl?.invalid && codeControl?.touched) {
              <small class="p-error block mt-3 text-center">
                @if (codeControl?.hasError('required')) {
                  <span>El código es requerido</span>
                }
                @if (codeControl?.hasError('pattern')) {
                  <span>El código debe tener 6 dígitos</span>
                }
              </small>
            }
          </div>

          <p-button
            type="submit"
            [disabled]="codeForm.invalid || isLoading"
            [loading]="isLoading"
            label="Verificar código"
            icon="pi pi-check"
            severity="primary"
            class="w-full justify-center"
            class="w-full">
          </p-button>

          <!-- Reenviar código -->
          <div class="text-center">
            <p class="text-sm text-gray-600 mb-2">¿No recibiste el código?</p>
            @if (!canResend) {
              <button 
                type="button"
                class="text-sm text-gray-400 cursor-not-allowed"
                disabled>
                Reenviar en {{ countdown }}s
              </button>
            } @else {
              <button 
                type="button"
                (click)="onResendCode()"
                [disabled]="isLoading"
                class="text-sm text-primary hover:text-primary-600 transition-colors font-medium">
                Reenviar código
              </button>
            }
          </div>
        </form>
      }

      <!-- Paso 3: Nueva contraseña -->
      @if (step === 3) {
        <div class="text-center mb-6">
          <i class="pi pi-lock text-4xl text-primary mb-4"></i>
          <h2 class="text-xl font-bold text-gray-800 mb-2">Nueva contraseña</h2>
          <p class="text-sm text-gray-600">
            Ingresa tu nueva contraseña para tu cuenta.
          </p>
        </div>

        <form [formGroup]="passwordForm" (ngSubmit)="onResetPassword()" class="space-y-6">
          <div class="field">
            <p-floatlabel>
              <p-password 
                id="newPassword"
                formControlName="newPassword"
                class="w-full"
                inputStyleClass="w-full"
                [toggleMask]="true"
                [feedback]="true"
                [class.ng-invalid]="newPasswordControl?.invalid && newPasswordControl?.touched">
              </p-password>
              <label for="newPassword">
                <i class="pi pi-lock mr-2 text-primary"></i>
                Nueva contraseña
              </label>
            </p-floatlabel>
            @if (newPasswordControl?.invalid && newPasswordControl?.touched) {
              <small class="p-error block mt-2">
                @if (newPasswordControl?.hasError('required')) {
                  <span>La contraseña es requerida</span>
                }
                @if (newPasswordControl?.hasError('minlength')) {
                  <span>La contraseña debe tener al menos 8 caracteres</span>
                }
              </small>
            }
          </div>

          <div class="field">
            <p-floatlabel>
              <p-password 
                id="confirmPassword"
                formControlName="confirmPassword"
                class="w-full"
                inputStyleClass="w-full"
                [toggleMask]="true"
                [feedback]="false"
                [class.ng-invalid]="confirmPasswordControl?.invalid && confirmPasswordControl?.touched">
              </p-password>
              <label for="confirmPassword">
                <i class="pi pi-lock mr-2 text-primary"></i>
                Confirmar contraseña
              </label>
            </p-floatlabel>
            @if (confirmPasswordControl?.invalid && confirmPasswordControl?.touched) {
              <small class="p-error block mt-2">
                @if (confirmPasswordControl?.hasError('required')) {
                  <span>Confirma tu contraseña</span>
                }
                @if (passwordForm.hasError('passwordMismatch') && confirmPasswordControl?.touched) {
                  <span>Las contraseñas no coinciden</span>
                }
              </small>
            }
          </div>

          <p-button
            type="submit"
            [disabled]="passwordForm.invalid || isLoading"
            [loading]="isLoading"
            label="Cambiar contraseña"
            icon="pi pi-check"
            severity="primary"
            class="w-full justify-center"
            class="w-full">
          </p-button>
        </form>
      }

      <!-- Paso 4: Éxito -->
      @if (step === 4) {
        <div class="text-center">
          <i class="pi pi-check-circle text-6xl text-green-500 mb-6"></i>
          <h2 class="text-xl font-bold text-gray-800 mb-4">¡Contraseña restablecida!</h2>
          <p class="text-sm text-gray-600 mb-6">
            Tu contraseña ha sido cambiada exitosamente. Ya puedes iniciar sesión con tu nueva contraseña.
          </p>
          
          <p-button
            (click)="goToLogin()"
            label="Ir al inicio de sesión"
            icon="pi pi-sign-in"
            severity="primary"
            class="w-full justify-center"
            class="w-full">
          </p-button>
        </div>
      }

      <!-- Error Message -->
      @if (errorMessage) {
        <p-message 
          severity="error" 
          [text]="errorMessage"
          class="mt-4">
        </p-message>
      }

      <!-- Success Message -->
      @if (successMessage) {
        <p-message 
          severity="success" 
          [text]="successMessage"
          class="mt-4">
        </p-message>
      }

      <!-- Volver al login -->
      @if (step < 4) {
        <div class="mt-8 text-center">
          <a routerLink="/login" class="text-sm text-primary hover:text-primary-600 transition-colors">
            <i class="pi pi-arrow-left mr-1"></i>
            Volver al inicio de sesión
          </a>
        </div>
      }
    </div>
  </div>
</div>
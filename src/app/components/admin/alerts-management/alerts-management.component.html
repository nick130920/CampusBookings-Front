<!-- Header Principal -->
<div class="surface-0 p-4 m-8 border-round shadow-2">
  <div class="flex justify-content-between align-items-center">
    <div>
      <h1 class="text-4xl font-bold text-primary mb-2">
        <i class="pi pi-bell mr-3"></i>
        Gestión de Alertas
      </h1>
      <p class="text-600 text-lg m-0">
        Administre las alertas y recordatorios automáticos del sistema
      </p>
    </div>
    <div class="flex gap-2">
      <p-button 
        label="Configurar Alertas" 
        icon="pi pi-cog" 
        severity="secondary"
        [outlined]="true"
        (click)="mostrarConfiguracion()">
      </p-button>
      <p-button 
        label="Actualizar" 
        icon="pi pi-refresh" 
        (click)="cargarDatos()"
        [loading]="loading()">
      </p-button>
    </div>
  </div>
</div>

<!-- Panel de Estadísticas -->
@if (showStatsPanel()) {
  <div class="m-8">
        <p-panel>
        <ng-template pTemplate="header">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-chart-bar text-primary"></i>
            <span class="font-semibold">Estadísticas del Sistema de Alertas</span>
            <p-button 
              icon="pi pi-minus" 
              severity="secondary" 
              [text]="true"
              size="small"
              (click)="toggleStatsPanel()">
            </p-button>
          </div>
        </ng-template>
        
        @if (estadisticas(); as stats) {
          <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4 p-4">
            <!-- Total de Alertas -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-bell text-3xl text-primary mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.totalAlertas }}</div>
                <div class="text-600 text-sm font-medium">Total Alertas</div>
              </div>
            </p-card>

            <!-- Alertas Pendientes -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-clock text-3xl text-orange-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.alertasPendientes }}</div>
                <div class="text-600 text-sm font-medium">Pendientes</div>
              </div>
            </p-card>

            <!-- Alertas Enviadas -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-check-circle text-3xl text-green-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.alertasEnviadas }}</div>
                <div class="text-600 text-sm font-medium">Enviadas</div>
              </div>
            </p-card>

            <!-- Alertas Fallidas -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-times-circle text-3xl text-red-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.alertasFallidas }}</div>
                <div class="text-600 text-sm font-medium">Fallidas</div>
              </div>
            </p-card>

            <!-- Alertas Canceladas -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-ban text-3xl text-gray-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.alertasCanceladas }}</div>
                <div class="text-600 text-sm font-medium">Canceladas</div>
              </div>
            </p-card>

            <!-- Tasa de Éxito -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-chart-line text-3xl text-blue-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ tasaExito() }}%</div>
                <div class="text-600 text-sm font-medium mb-2">Tasa de Éxito</div>
                <p-progressBar 
                  [value]="tasaExito()" 
                  [showValue]="false"
                  class="mt-1">
                </p-progressBar>
              </div>
            </p-card>
          </div>
        }
        </p-panel>
  </div>
} @else {
  <div class="flex justify-content-end mb-4">
    <p-button 
      label="Mostrar Estadísticas" 
      icon="pi pi-plus" 
      severity="secondary" 
      [text]="true"
      (click)="toggleStatsPanel()">
    </p-button>
  </div>
}

<!-- Barra de Herramientas -->
<p-toolbar class="m-8">
  <ng-template pTemplate="start">
    <div class="flex gap-2">
      <p-button 
        label="Procesar Pendientes" 
        icon="pi pi-cog" 
        (click)="procesarAlertasPendientes()">
      </p-button>
      <p-button 
        label="Limpiar Vencidas" 
        icon="pi pi-trash" 
        severity="danger"
        [outlined]="true"
        (click)="limpiarAlertasVencidas()">
      </p-button>
    </div>
  </ng-template>
  
  <ng-template pTemplate="end">
    <div class="flex align-items-center gap-2">
      <label for="filtroEstado" class="font-semibold">Filtrar por estado:</label>
      <p-select 
        id="filtroEstado"
        [options]="estadoOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Todos los estados"
        ngModel="filtroEstado()"
        (onChange)="onFiltroEstadoChange($event.value)"
        class="w-10rem">
      </p-select>
    </div>
  </ng-template>
</p-toolbar>

<!-- Tabla de Alertas -->
<p-card class="m-8">
  <ng-template pTemplate="header">
    <div class="flex align-items-center gap-2">
      <i class="pi pi-list text-primary"></i>
      <span class="font-semibold">Lista de Alertas</span>
      <p-chip 
        [label]="alertasFiltradas().length.toString()" 
        class="ml-2">
      </p-chip>
    </div>
  </ng-template>

  @if (loading()) {
    <div class="flex justify-content-center align-items-center" style="height: 200px;">
      <p-progressSpinner></p-progressSpinner>
    </div>
  } @else {
    <p-table 
      [value]="alertasFiltradas()" 
      [paginator]="true" 
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} alertas"
      [rowsPerPageOptions]="[10, 25, 50]"
      [sortField]="'fechaEnvio'"
      [sortOrder]="-1"
      class="p-datatable-gridlines">
      
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="tipo">
            Tipo <p-sortIcon field="tipo"></p-sortIcon>
          </th>
          <th pSortableColumn="reservaEscenario">
            Escenario <p-sortIcon field="reservaEscenario"></p-sortIcon>
          </th>
          <th pSortableColumn="reservaUsuario">
            Usuario <p-sortIcon field="reservaUsuario"></p-sortIcon>
          </th>
          <th pSortableColumn="fechaEnvio">
            Fecha de Envío <p-sortIcon field="fechaEnvio"></p-sortIcon>
          </th>
          <th pSortableColumn="estado">
            Estado <p-sortIcon field="estado"></p-sortIcon>
          </th>
          <th>Canal</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-alerta>
        <tr>
          <!-- Tipo de Alerta -->
          <td>
            <div class="flex align-items-center gap-2">
              <i [class]="getAlertIcon(alerta.tipo)" 
                 [style.color]="getTipoColor(alerta.tipo)"></i>
              <span class="font-medium">{{ alerta.tipoDescripcion }}</span>
            </div>
          </td>
          
          <!-- Escenario -->
          <td>
            <span class="font-medium text-primary">{{ alerta.reservaEscenario }}</span>
            <div class="text-sm text-600">ID Reserva: {{ alerta.reservaId }}</div>
          </td>
          
          <!-- Usuario -->
          <td>
            <span>{{ alerta.reservaUsuario }}</span>
          </td>
          
          <!-- Fecha de Envío -->
          <td>
            <div>{{ formatearFecha(alerta.fechaEnvio) }}</div>
            @if (alerta.fechaEnviado) {
              <div class="text-sm text-green-600">
                Enviado: {{ formatearFecha(alerta.fechaEnviado) }}
              </div>
            }
          </td>
          
          <!-- Estado -->
          <td>
            <p-tag 
              [value]="alerta.estadoDescripcion"
              [severity]="getEstadoSeverity(alerta.estado)">
            </p-tag>
            @if (alerta.intentosEnvio && alerta.intentosEnvio > 1) {
              <div class="text-sm text-orange-600 mt-1">
                Intentos: {{ alerta.intentosEnvio }}
              </div>
            }
          </td>
          
          <!-- Canal -->
          <td>
            <p-chip [label]="alerta.canalEnvio"></p-chip>
          </td>
          
          <!-- Acciones -->
          <td>
            <div class="flex gap-1">
              @if (puedeEnviar(alerta)) {
                <p-button 
                  icon="pi pi-send" 
                  severity="success"
                  size="small"
                  [text]="true"
                  pTooltip="Enviar ahora"
                  (click)="enviarAlerta(alerta)">
                </p-button>
              }
              
              @if (puedeCancelar(alerta)) {
                <p-button 
                  icon="pi pi-times" 
                  severity="danger"
                  size="small"
                  [text]="true"
                  pTooltip="Cancelar alerta"
                  (click)="cancelarAlerta(alerta)">
                </p-button>
              }
              
              @if (puedeReenviar(alerta)) {
                <p-button 
                  icon="pi pi-refresh" 
                  severity="info"
                  size="small"
                  [text]="true"
                  pTooltip="Reenviar alerta"
                  (click)="reenviarAlerta(alerta)">
                </p-button>
              }
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center p-6">
            <div class="empty-state">
              <i class="pi pi-bell-slash text-6xl text-400 mb-4 block"></i>
              <div class="text-xl text-700 font-medium mb-2">No hay alertas disponibles</div>
              <div class="text-600">Las alertas aparecerán aquí cuando se generen automáticamente o se configuren manualmente.</div>
              <p-button 
                label="Configurar Alertas" 
                icon="pi pi-cog" 
                severity="secondary"
                [outlined]="true"
                size="small"
                class="mt-3"
                (click)="mostrarConfiguracion()">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
</p-card>

<!-- Dialog de Configuración -->
<p-dialog 
  header="Configurar Alertas" 
  [modal]="true"
  [visible]="showConfigDialog()"
  (visibleChange)="showConfigDialog.set($event)"
  [style]="{ width: '700px' }">
  
  <form [formGroup]="configForm" (ngSubmit)="guardarConfiguracion()">
    <div class="grid">
      <!-- Tipos de Alerta -->
      <div class="col-12">
        <label for="tiposAlerta" class="block font-medium mb-2">
          Tipos de Alerta <span class="text-red-500">*</span>
        </label>
        <p-multiSelect 
          id="tiposAlerta"
          formControlName="tiposAlerta"
          [options]="tipoAlertaOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione tipos de alerta"
          class="w-full">
        </p-multiSelect>
      </div>

      <!-- Canales de Envío -->
      <div class="col-12 md:col-6">
        <label for="canalesEnvio" class="block font-medium mb-2">
          Canales de Envío <span class="text-red-500">*</span>
        </label>
        <p-multiSelect 
          id="canalesEnvio"
          formControlName="canalesEnvio"
          [options]="canalEnvioOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione canales"
          class="w-full">
        </p-multiSelect>
      </div>

      <!-- Habilitar Recordatorios -->
      <div class="col-12 md:col-6">
        <div class="field-checkbox mt-4">
          <p-checkbox 
            id="habilitarRecordatorios"
            formControlName="habilitarRecordatorios"
            binary="true">
          </p-checkbox>
          <label for="habilitarRecordatorios" class="ml-2">
            Habilitar recordatorios automáticos
          </label>
        </div>
      </div>

      <!-- Configuración de Tiempos -->
      <div class="col-12">
        <p-divider align="left">
          <div class="inline-flex align-items-center">
            <i class="pi pi-clock mr-2"></i>
            <b>Configuración de Tiempos</b>
          </div>
        </p-divider>
      </div>

      <div class="col-12 md:col-4">
        <label for="horas24" class="block font-medium mb-2">Horas 24h</label>
        <p-inputNumber 
          id="horas24"
          formControlName="horasAnticipacion24h"
          [min]="1"
          [max]="48"
          suffix=" horas"
          class="w-full">
        </p-inputNumber>
      </div>

      <div class="col-12 md:col-4">
        <label for="horas2" class="block font-medium mb-2">Horas 2h</label>
        <p-inputNumber 
          id="horas2"
          formControlName="horasAnticipacion2h"
          [min]="1"
          [max]="12"
          suffix=" horas"
          class="w-full">
        </p-inputNumber>
      </div>

      <div class="col-12 md:col-4">
        <label for="minutos30" class="block font-medium mb-2">Minutos 30min</label>
        <p-inputNumber 
          id="minutos30"
          formControlName="minutosAnticipacion30min"
          [min]="5"
          [max]="120"
          suffix=" min"
          class="w-full">
        </p-inputNumber>
      </div>

      <!-- Mensaje Personalizado -->
      <div class="col-12">
        <label for="mensaje" class="block font-medium mb-2">Mensaje Personalizado</label>
        <input 
          id="mensaje"
          type="text" 
          pInputText 
          formControlName="mensajePersonalizado"
          placeholder="Mensaje personalizado opcional"
          class="w-full">
      </div>

      <!-- Aplicar a todos los escenarios -->
      <div class="col-12">
        <div class="field-checkbox">
          <p-checkbox 
            id="aplicarTodos"
            formControlName="aplicarATodosLosEscenarios"
            binary="true">
          </p-checkbox>
          <label for="aplicarTodos" class="ml-2">
            Aplicar configuración a todos los tipos de escenarios
          </label>
        </div>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="flex gap-2 justify-content-end">
      <p-button 
        label="Cancelar" 
        severity="secondary"
        [outlined]="true"
        (click)="showConfigDialog.set(false)">
      </p-button>
      <p-button 
        label="Guardar Configuración" 
        icon="pi pi-save"
        (click)="guardarConfiguracion()"
        [disabled]="configForm.invalid">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Toast y Confirm Dialog -->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

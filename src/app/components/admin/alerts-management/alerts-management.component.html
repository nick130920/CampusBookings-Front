<!-- Header Principal -->
<div class="surface-0 p-4 m-8 border-round shadow-2">
  <div class="flex justify-content-between align-items-center">
    <div>
      <h1 class="text-4xl font-bold text-primary mb-2">
        <i class="pi pi-bell mr-3"></i>
        Gestión de Alertas
      </h1>
      <p class="text-600 text-lg m-0">
        Administre las alertas y recordatorios automáticos del sistema
      </p>
    </div>
    <div class="flex gap-2">
      <p-button 
        label="Configurar Alertas" 
        icon="pi pi-cog" 
        severity="secondary"
        [outlined]="true"
        (click)="mostrarConfiguracion()">
      </p-button>
      <p-button 
        label="Actualizar" 
        icon="pi pi-refresh" 
        (click)="cargarDatos()"
        [loading]="loading()">
      </p-button>
    </div>
  </div>
</div>

<!-- Panel de Estadísticas -->
@if (showStatsPanel()) {
  <div class="mx-8 my-4">
        <p-panel>
        <ng-template pTemplate="header">
          <div class="flex align-items-center gap-2 items-stretch mx-8">
            <i class="pi pi-chart-bar text-primary self-center"></i>
            <span class="font-semibold self-center">Estadísticas del Sistema de Alertas</span>
            <p-button 
              icon="pi pi-minus" 
              severity="secondary" 
              [text]="true"
              size="small"
              class="self-center"
              (click)="toggleStatsPanel()">
            </p-button>
          </div>
        </ng-template>
        
        @if (estadisticas(); as stats) {
          <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4 p-4">
            <!-- Total de Alertas -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-bell text-3xl text-primary mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.totalAlertas }}</div>
                <div class="text-600 text-sm font-medium">Total Alertas</div>
              </div>
            </p-card>

            <!-- Alertas Pendientes -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-clock text-3xl text-orange-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.alertasPendientes }}</div>
                <div class="text-600 text-sm font-medium">Pendientes</div>
              </div>
            </p-card>

            <!-- Alertas Enviadas -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-check-circle text-3xl text-green-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.alertasEnviadas }}</div>
                <div class="text-600 text-sm font-medium">Enviadas</div>
              </div>
            </p-card>

            <!-- Alertas Fallidas -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-times-circle text-3xl text-red-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.alertasFallidas }}</div>
                <div class="text-600 text-sm font-medium">Fallidas</div>
              </div>
            </p-card>

            <!-- Alertas Canceladas -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-ban text-3xl text-gray-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ stats.alertasCanceladas }}</div>
                <div class="text-600 text-sm font-medium">Canceladas</div>
              </div>
            </p-card>

            <!-- Tasa de Éxito -->
            <p-card class="h-full stats-card">
              <div class="text-center p-3">
                <i class="pi pi-chart-line text-3xl text-blue-500 mb-2 block"></i>
                <div class="text-2xl font-bold text-900 mb-1">{{ tasaExito() }}%</div>
                <div class="text-600 text-sm font-medium mb-2">Tasa de Éxito</div>
                <p-progressBar 
                  [value]="tasaExito()" 
                  [showValue]="false"
                  class="mt-1">
                </p-progressBar>
              </div>
            </p-card>
          </div>
        }
        </p-panel>
  </div>
} @else {
  <div class="flex justify-content-end mb-4">
    <p-button 
      label="Mostrar Estadísticas" 
      icon="pi pi-plus" 
      severity="secondary" 
      [text]="true"
      (click)="toggleStatsPanel()">
    </p-button>
  </div>
}

<!-- Barra de Herramientas -->
<p-toolbar class="mx-8">
  <ng-template pTemplate="start">
    <div class="flex gap-2">
      @if (canManageAlerts()) {
        <p-button 
          label="Procesar Pendientes" 
          icon="pi pi-cog" 
          (click)="procesarAlertasPendientes()">
        </p-button>
        <p-button 
          label="Limpiar Vencidas" 
          icon="pi pi-trash" 
          severity="danger"
          [outlined]="true"
          (click)="limpiarAlertasVencidas()">
        </p-button>
      } @else {
        <div class="surface-100 p-3 border-round">
          <small class="text-600 font-italic">
            <i class="pi pi-lock mr-2"></i>
            Solo usuarios COORDINATOR o ADMIN pueden gestionar alertas
          </small>
        </div>
      }
    </div>
  </ng-template>
  
  <ng-template pTemplate="end">
    <div class="flex align-items-center gap-2 items-stretch">
      <label for="filtroEstado" class="font-semibold self-center">Filtrar por estado:</label>
      <p-select 
        id="filtroEstado"
        [options]="estadoOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Todos los estados"
        ngModel="filtroEstado()"
        (onChange)="onFiltroEstadoChange($event.value)"
        class="w-10rem self-center">
      </p-select>
    </div>
  </ng-template>
</p-toolbar>

<!-- Tabla de Alertas -->
<p-card class="mx-8 mt-2">
  <ng-template pTemplate="header">
    <div class="flex align-items-center justify-content-between px-8 pt-8 space-x-3 items-stretch" style="min-height: 3rem;">
        <i class="pi pi-list text-primary text-xl self-center"></i>
        <span class="font-semibold text-lg self-center">Lista de Alertas</span>
        <p-chip 
          [label]="alertasFiltradas().length.toString()">
        </p-chip>
    </div>
  </ng-template>

  @if (loading()) {
    <div class="flex justify-content-center align-items-center" style="height: 200px;">
      <p-progressSpinner></p-progressSpinner>
    </div>
  } @else {
    <p-table 
      [value]="alertasFiltradas()" 
      [paginator]="true" 
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} alertas"
      [rowsPerPageOptions]="[10, 25, 50]"
      [sortField]="'fechaEnvio'"
      [sortOrder]="-1"
      class="p-datatable-gridlines">
      
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="tipo">
            Tipo <p-sortIcon field="tipo"></p-sortIcon>
          </th>
          <th pSortableColumn="reservaEscenario">
            Escenario <p-sortIcon field="reservaEscenario"></p-sortIcon>
          </th>
          <th pSortableColumn="reservaUsuario">
            Usuario <p-sortIcon field="reservaUsuario"></p-sortIcon>
          </th>
          <th pSortableColumn="fechaEnvio">
            Fecha de Envío <p-sortIcon field="fechaEnvio"></p-sortIcon>
          </th>
          <th pSortableColumn="estado">
            Estado <p-sortIcon field="estado"></p-sortIcon>
          </th>
          <th>Canal</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-alerta>
        <tr>
          <!-- Tipo de Alerta -->
          <td>
            <div class="flex align-items-center gap-2">
              <i [class]="getAlertIcon(alerta.tipo)" 
                 [style.color]="getTipoColor(alerta.tipo)"></i>
              <span class="font-medium">{{ alerta.tipoDescripcion }}</span>
            </div>
          </td>
          
          <!-- Escenario -->
          <td>
            <span class="font-medium text-primary">{{ alerta.reservaEscenario }}</span>
            <div class="text-sm text-600">ID Reserva: {{ alerta.reservaId }}</div>
          </td>
          
          <!-- Usuario -->
          <td>
            <span>{{ alerta.reservaUsuario }}</span>
          </td>
          
          <!-- Fecha de Envío -->
          <td>
            <div>{{ formatearFecha(alerta.fechaEnvio) }}</div>
            @if (alerta.fechaEnviado) {
              <div class="text-sm text-green-600">
                Enviado: {{ formatearFecha(alerta.fechaEnviado) }}
              </div>
            }
          </td>
          
          <!-- Estado -->
          <td>
            <p-tag 
              [value]="alerta.estadoDescripcion"
              [severity]="getEstadoSeverity(alerta.estado)">
            </p-tag>
            @if (alerta.intentosEnvio && alerta.intentosEnvio > 1) {
              <div class="text-sm text-orange-600 mt-1">
                Intentos: {{ alerta.intentosEnvio }}
              </div>
            }
          </td>
          
          <!-- Canal -->
          <td>
            <p-chip [label]="alerta.canalEnvio"></p-chip>
          </td>
          
          <!-- Acciones -->
          <td>
            <div class="flex gap-1">
              @if (canManageAlerts() && puedeEnviar(alerta)) {
                <p-button 
                  icon="pi pi-send" 
                  severity="success"
                  size="small"
                  [text]="true"
                  pTooltip="Enviar ahora"
                  (click)="enviarAlerta(alerta)">
                </p-button>
              }
              
              @if (canManageAlerts() && puedeCancelar(alerta)) {
                <p-button 
                  icon="pi pi-times" 
                  severity="danger"
                  size="small"
                  [text]="true" 
                  pTooltip="Cancelar alerta"
                  (click)="cancelarAlerta(alerta)">
                </p-button>
              }
              
              @if (canManageAlerts() && puedeReenviar(alerta)) {
                <p-button 
                  icon="pi pi-refresh" 
                  severity="info"
                  size="small"
                  [text]="true"
                  pTooltip="Reenviar alerta"
                  (click)="reenviarAlerta(alerta)">
                </p-button>
              }
              
              @if (!canManageAlerts()) {
                <small class="text-600 font-italic">Sin permisos</small>
              }
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center p-6">
            <div class="empty-state">
              <i class="pi pi-bell-slash text-6xl text-400 mb-4 block"></i>
              <div class="text-xl text-700 font-medium mb-2">No hay alertas disponibles</div>
              <div class="text-600">Las alertas aparecerán aquí cuando se generen automáticamente o se configuren manualmente.</div>
              <p-button 
                label="Configurar Alertas" 
                icon="pi pi-cog" 
                severity="secondary"
                [outlined]="true"
                size="small"
                class="mt-3"
                (click)="mostrarConfiguracion()">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
</p-card>

<!-- Dialog de Configuración -->
<p-dialog 
  header="Configurar Alertas" 
  [modal]="true"
  [visible]="showConfigDialog()"
  (visibleChange)="showConfigDialog.set($event)"
  [style]="{ width: '800px' }"
  [draggable]="false"
  [resizable]="false">
  
  <form [formGroup]="configForm" (ngSubmit)="guardarConfiguracion()">
    <div class="p-6 space-y-6">
      <!-- Sección Principal -->
      <div>
        <h3 class="text-xl font-semibold text-900 mb-4 flex items-center gap-2">
          <i class="pi pi-bell text-primary"></i>
          Configuración Básica
        </h3>
        
        <div class="space-y-4">
          <!-- Tipos de Alerta -->
          <div>
            <label for="tiposAlerta" class="block font-semibold mb-3 text-900">
              Tipos de Alerta <span class="text-red-500">*</span>
            </label>
            <p-multiSelect 
              id="tiposAlerta"
              formControlName="tiposAlerta"
              [options]="tipoAlertaOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Seleccione tipos de alerta"
              class="w-full"
              [showToggleAll]="true"
              [filter]="true">
            </p-multiSelect>
          </div>

          <!-- Canales de Envío y Recordatorios -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label for="canalesEnvio" class="block font-semibold mb-3 text-900">
                Canales de Envío <span class="text-red-500">*</span>
              </label>
              <p-multiSelect 
                id="canalesEnvio"
                formControlName="canalesEnvio"
                [options]="canalEnvioOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Seleccione canales"
                class="w-full">
              </p-multiSelect>
            </div>
            
            <div class="flex items-end">
              <div class="surface-100 p-4 border-round w-full">
                <div class="flex items-center">
                  <p-checkbox 
                    id="habilitarRecordatorios"
                    formControlName="habilitarRecordatorios"
                    binary="true">
                  </p-checkbox>
                  <label for="habilitarRecordatorios" class="ml-2 font-medium text-sm">
                    Habilitar recordatorios automáticos
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuración de Tiempos -->
      <div>
        <h3 class="text-xl font-semibold text-900 mb-4 flex items-center gap-2">
          <i class="pi pi-clock text-primary"></i>
          Configuración de Tiempos
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="horas24" class="block font-semibold mb-2 text-900">
              Recordatorio 24 horas
            </label>
            <p-inputNumber 
              id="horas24"
              formControlName="horasAnticipacion24h"
              [min]="1"
              [max]="48"
              suffix=" horas"
              class="w-full">
            </p-inputNumber>
            <small class="text-600">Alertar 24 horas antes</small>
          </div>

          <div>
            <label for="horas2" class="block font-semibold mb-2 text-900">
              Recordatorio 2 horas
            </label>
            <p-inputNumber 
              id="horas2"
              formControlName="horasAnticipacion2h"
              [min]="1"
              [max]="12"
              suffix=" horas"
              class="w-full">
            </p-inputNumber>
            <small class="text-600">Alertar 2 horas antes</small>
          </div>

          <div>
            <label for="minutos30" class="block font-semibold mb-2 text-900">
              Recordatorio 30 minutos
            </label>
            <p-inputNumber 
              id="minutos30"
              formControlName="minutosAnticipacion30min"
              [min]="5"
              [max]="120"
              suffix=" minutos"
              class="w-full">
            </p-inputNumber>
            <small class="text-600">Alertar 30 minutos antes</small>
          </div>
        </div>
      </div>

      <!-- Configuración Avanzada -->
      <div>
        <h3 class="text-xl font-semibold text-900 mb-4 flex items-center gap-2">
          <i class="pi pi-cog text-primary"></i>
          Configuración Avanzada
        </h3>
        
        <div class="space-y-4">
          <!-- Mensaje Personalizado -->
          <div>
            <label for="mensaje" class="block font-semibold mb-2 text-900">
              Mensaje Personalizado
            </label>
            <input 
              id="mensaje"
              type="text" 
              pInputText 
              formControlName="mensajePersonalizado"
              placeholder="Mensaje personalizado opcional para las alertas"
              class="w-full">
            <small class="text-600">Este mensaje se incluirá en todas las alertas</small>
          </div>

          <!-- Aplicar a todos los escenarios -->
          <div>
            <div class="surface-100 p-4 border-round">
              <div class="flex items-center">
                <p-checkbox 
                  id="aplicarTodos"
                  formControlName="aplicarATodosLosEscenarios"
                  binary="true">
                </p-checkbox>
                <div class="ml-3">
                  <label for="aplicarTodos" class="font-semibold text-900 block">
                    Aplicar configuración a todos los tipos de escenarios
                  </label>
                  <small class="text-600">
                    Esta configuración se aplicará a todos los escenarios del sistema
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="flex gap-3 justify-content-end p-4 surface-50">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times"
        severity="secondary"
        [outlined]="true"
        (click)="showConfigDialog.set(false)">
      </p-button>
      <p-button 
        label="Guardar Configuración" 
        icon="pi pi-check"
        (click)="guardarConfiguracion()"
        [disabled]="configForm.invalid">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Toast y Confirm Dialog -->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

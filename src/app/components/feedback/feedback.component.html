<!-- Contenedor principal del componente de feedback -->
<div class="feedback-container">
  
  <!-- Indicador de carga -->
  @if (isLoading) {
    <div class="flex justify-center items-center py-8">
      <p-progressSpinner class="w-8 h-8"></p-progressSpinner>
    </div>
  }

  <!-- Contenido principal -->
  @if (!isLoading) {
    
    <!-- Estadísticas del escenario -->
    @if (mostrarEstadisticas && estadisticas) {
      <p-card class="mb-6 estadisticas-card">
        <div class="flex flex-col lg:flex-row gap-6">
          
          <!-- Resumen de calificación -->
          <div class="text-center lg:text-left">
            <div class="flex items-center justify-center lg:justify-start gap-3 mb-3">
              <span class="text-4xl font-bold text-usco-vino">
                {{ estadisticas.calificacionPromedio | number:'1.1-1' }}
              </span>
              <div class="flex flex-col">
                <p-rating 
                  [(ngModel)]="estadisticas.calificacionPromedio" 
                  [readonly]="true"
                  class="text-usco-vino">
                </p-rating>
                <span class="text-sm text-usco-gris-600 mt-1">
                  {{ estadisticas.totalFeedbacks }} 
                  {{ estadisticas.totalFeedbacks === 1 ? 'reseña' : 'reseñas' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Distribución de calificaciones -->
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-usco-gris-800 mb-3">Distribución de calificaciones</h4>
            
            @for (item of [5,4,3,2,1]; track $index) {
              <div class="flex items-center gap-3 mb-2">
                <span class="text-sm text-usco-gris-600 w-8">{{ item }}★</span>
                <div class="flex-1 bg-usco-gris-200 rounded-full h-2">
                  <div 
                    class="bg-usco-vino h-2 rounded-full transition-all duration-300"
                    [style.width.%]="obtenerPorcentaje(estadisticas.distribucionCalificaciones[item-1])">
                  </div>
                </div>
                <span class="text-sm text-usco-gris-600 w-8">
                  {{ estadisticas.distribucionCalificaciones[item-1] }}
                </span>
              </div>
            }
          </div>
        </div>
      </p-card>
    }

    <!-- Mi feedback / Formulario -->
    @if (!soloLectura) {
      <p-card class="mb-6 mi-feedback-card">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-xl font-semibold text-usco-gris-800">
            {{ miFeedback ? 'Mi reseña' : 'Deja tu reseña' }}
          </h3>
          
          @if (miFeedback && !mostrarFormulario) {
            <div class="flex gap-2">
              <p-button 
                (onClick)="mostrarFormularioFeedback()"
                icon="pi pi-pencil"
                [text]="true"
                label="Editar"
                size="small"
                class="text-usco-vino hover:bg-usco-vino-50">
              </p-button>
              <p-button 
                (onClick)="eliminarFeedback()"
                icon="pi pi-trash"
                [text]="true"
                severity="danger"
                size="small"
                class="text-red-600 hover:bg-red-50">
              </p-button>
            </div>
          }
        </div>

        <!-- Mi feedback existente -->
        @if (miFeedback && !mostrarFormulario) {
          <div class="bg-usco-gris-50 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-3">
              <p-rating 
                [(ngModel)]="miFeedback.calificacion" 
                [readonly]="true"
                class="text-usco-vino">
              </p-rating>
              <span class="text-sm text-usco-gris-600">
                {{ obtenerTextoCalificacion(miFeedback.calificacion) }}
              </span>
            </div>
            
            @if (miFeedback.comentario) {
              <p class="text-usco-gris-700 mb-3">{{ miFeedback.comentario }}</p>
            }
            
            <div class="text-xs text-usco-gris-500">
              Publicado el {{ formatearFecha(miFeedback.fechaCreacion) }}
              @if (miFeedback.fechaModificacion && miFeedback.fechaModificacion !== miFeedback.fechaCreacion) {
                · Editado el {{ formatearFecha(miFeedback.fechaModificacion) }}
              }
            </div>
          </div>
        }

        <!-- Botón para mostrar formulario (si no hay feedback) -->
        @if (!miFeedback && !mostrarFormulario) {
          <div class="text-center py-8">
            <div class="mb-4">
              <i class="pi pi-star text-4xl text-usco-gris-400"></i>
            </div>
            <p class="text-usco-gris-600 mb-4">¿Has usado este escenario? Comparte tu experiencia</p>
            <p-button 
              (onClick)="mostrarFormularioFeedback()"
              label="Escribir reseña"
              icon="pi pi-star"
              class="p-button-outlined">
            </p-button>
          </div>
        }

        <!-- Formulario de feedback -->
        @if (mostrarFormulario) {
          <form [formGroup]="feedbackForm" (ngSubmit)="onSubmit()">
            
            <!-- Mensaje de error -->
            @if (errorMessage) {
              <p-message severity="error" [text]="errorMessage" class="mb-4"></p-message>
            }

            <!-- Calificación -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-usco-gris-700 mb-2">
                Calificación *
              </label>
              <div class="flex items-center gap-3">
                <p-rating 
                  formControlName="calificacion"
                  class="text-usco-vino">
                </p-rating>
                @if (calificacion && calificacion.value !== null) {
                  <span class="text-sm text-usco-gris-600">
                    {{ obtenerTextoCalificacion(calificacion.value!) }}
                  </span>
                }
              </div>
              
              @if (calificacion?.invalid && calificacion?.touched) {
                <small class="text-red-600">La calificación es obligatoria</small>
              }
            </div>

            <!-- Comentario -->
            <div class="mb-6">
              <p-floatlabel>
                <textarea 
                  id="comentario"
                  pTextarea 
                  formControlName="comentario"
                  rows="4" 
                  cols="30"
                  class="w-full"
                  maxlength="1000"
                  placeholder="Comparte tu experiencia con este escenario (opcional)">
                </textarea>
                <label for="comentario">Comentario</label>
              </p-floatlabel>
              
              <div class="text-right mt-1">
                <small class="text-usco-gris-500">
                  {{ comentario?.value?.length || 0 }}/1000 caracteres
                </small>
              </div>
              
              @if (comentario?.invalid && comentario?.touched) {
                <small class="text-red-600">El comentario no puede exceder los 1000 caracteres</small>
              }
            </div>

            <!-- Botones del formulario -->
            <div class="flex gap-3 justify-end">
              <p-button 
                (onClick)="ocultarFormulario()"
                label="Cancelar"
                [text]="true"
                type="button"
                [disabled]="isSaving">
              </p-button>
              <p-button 
                type="submit"
                [label]="modoEdicion ? 'Actualizar' : 'Publicar'"
                [loading]="isSaving"
                [disabled]="feedbackForm.invalid">
              </p-button>
            </div>
          </form>
        }
      </p-card>
    }

    <!-- Lista de feedbacks -->
    @if (mostrarListaFeedbacks && feedbacks.length > 0) {
      <p-card class="feedbacks-list-card">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-usco-gris-800">
            Reseñas de usuarios
          </h3>
          <span class="text-sm text-usco-gris-600">
            {{ totalRecords }} {{ totalRecords === 1 ? 'reseña' : 'reseñas' }}
          </span>
        </div>

        <!-- Items de feedback -->
        @for (feedback of feedbacks; track feedback.id) {
          <div class="feedback-item border-b border-usco-gris-200 pb-4 mb-4 last:border-b-0 last:mb-0">
            <div class="flex gap-4">
              
              <!-- Avatar -->
              <p-avatar 
                [label]="obtenerIniciales(feedback.usuarioNombre, feedback.usuarioApellido)"
                class="bg-usco-vino text-white"
                size="large">
              </p-avatar>

              <!-- Contenido del feedback -->
              <div class="flex-1">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <h5 class="font-semibold text-usco-gris-800">
                      {{ feedback.usuarioNombre }} {{ feedback.usuarioApellido }}
                    </h5>
                    <div class="flex items-center gap-2 mt-1">
                      <p-rating 
                        [(ngModel)]="feedback.calificacion" 
                        [readonly]="true"
                        class="text-usco-vino">
                      </p-rating>
                      <span class="text-sm text-usco-gris-600">
                        {{ obtenerTextoCalificacion(feedback.calificacion) }}
                      </span>
                    </div>
                  </div>
                  
                  <span class="text-xs text-usco-gris-500">
                    {{ formatearFecha(feedback.fechaCreacion) }}
                  </span>
                </div>

                @if (feedback.comentario) {
                  <p class="text-usco-gris-700 leading-relaxed">
                    {{ feedback.comentario }}
                  </p>
                }
              </div>
            </div>
          </div>
        }

        <!-- Paginador -->
        @if (totalRecords > pageSize) {
          <p-paginator 
            [rows]="pageSize"
            [totalRecords]="totalRecords"
            [first]="currentPage * pageSize"
            (onPageChange)="onPageChange($event)"
            [rowsPerPageOptions]="[5, 10, 20]"
            class="mt-6">
          </p-paginator>
        }
      </p-card>
    }

    <!-- Mensaje cuando no hay feedbacks -->
    @if (mostrarListaFeedbacks && feedbacks.length === 0 && !isLoading) {
      <p-card class="text-center py-8">
        <div class="mb-4">
          <i class="pi pi-comment text-4xl text-usco-gris-400"></i>
        </div>
        <p class="text-usco-gris-600">
          Aún no hay reseñas para este escenario. ¡Sé el primero en dejar una!
        </p>
      </p-card>
    }
  }
</div>

<!-- Dialog de confirmación -->
<p-confirmDialog></p-confirmDialog>

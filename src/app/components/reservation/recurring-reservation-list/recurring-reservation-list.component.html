<div class="container mx-auto p-6">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-usco-vino-500 mb-2">Mis Reservas Recurrentes</h1>
        <p class="text-usco-gris-600">Gestione sus configuraciones de reservas automáticas</p>
      </div>
      
      <p-button 
        label="Nueva Reserva Recurrente"
        icon="pi pi-plus"
        routerLink="/dashboard/reservas/recurrente">
      </p-button>
    </div>

    <!-- Loading State -->
    @if (loading()) {
      <div class="text-center py-12">
        <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}"></p-progressSpinner>
        <p class="mt-4 text-usco-gris-600">Cargando reservas recurrentes...</p>
      </div>
    }

    <!-- Empty State -->
    @if (!loading() && reservations().length === 0) {
      <p-card class="shadow-usco border-0">
        <div class="text-center py-12">
          <i class="pi pi-calendar text-6xl text-usco-gris-300 mb-4 block"></i>
          <h3 class="text-xl font-semibold text-usco-gris-700 mb-2">No tienes reservas recurrentes</h3>
          <p class="text-usco-gris-500 mb-6">Crea tu primera reserva recurrente para automatizar tus reservas.</p>
          <p-button 
            label="Crear Primera Reserva Recurrente"
            icon="pi pi-plus"
            routerLink="/dashboard/reservas/recurrente">
          </p-button>
        </div>
      </p-card>
    }

    <!-- Reservations List -->
    @if (!loading() && reservations().length > 0) {
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <p-dataView 
          [value]="reservations()" 
          layout="grid"
          [paginator]="true"
          [rows]="6"
          [rowsPerPageOptions]="[6, 12, 18]">
          
          <ng-template #grid let-items>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                @for (reservation of items; track reservation.id) {
                  <div class="col-span-1 relative">
                    <div class="h-full bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200 overflow-hidden">
                      <!-- Header with status and actions -->
                      <div class="flex justify-between items-start p-4 pb-3 border-b border-gray-100">
                        <div class="flex items-center gap-2 flex-wrap">
                          <p-tag 
                            [value]="reservation.activa ? 'Activa' : 'Inactiva'"
                            [severity]="reservation.activa ? 'success' : 'warning'"
                            [class]="reservation.activa ? 'bg-green-100 text-green-800 border-green-200' : 'bg-orange-100 text-orange-700 border-orange-200'"
                            [rounded]="true">
                          </p-tag>
                          
                          @if (!reservation.puedeGenerarMas) {
                            <p-tag 
                              value="Completada"
                              severity="info"
                              class="bg-blue-100 text-blue-800 border-blue-200"
                              [rounded]="true">
                            </p-tag>
                          }
                        </div>
                        
                        <p-button 
                          icon="pi pi-ellipsis-v"
                          [text]="true"
                          [rounded]="true"
                          size="small"
                          class="text-gray-500 hover:text-usco-vino-600 hover:bg-gray-100 transition-colors duration-200 flex-shrink-0"
                          (onClick)="showMenu($event, reservation)">
                        </p-button>
                      </div>

                      <!-- Content -->
                      <div class="p-4 space-y-4">
                        <!-- Escenario Info -->
                        <div>
                          <h3 class="font-semibold text-lg text-gray-800 mb-1 line-clamp-1">
                            {{ reservation.escenarioNombre }}
                          </h3>
                          <div class="flex items-center gap-2 text-sm text-gray-500">
                            <i class="pi pi-map-marker text-xs"></i>
                            <span>ID: {{ reservation.escenarioId }}</span>
                          </div>
                        </div>

                        <!-- Pattern Description -->
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                          <div class="flex items-center gap-2 mb-2">
                            <i class="pi pi-refresh text-usco-vino-500 text-sm"></i>
                            <span class="font-medium text-sm text-gray-700">{{ getPatronLabel(reservation.patron) }}</span>
                          </div>
                          <p class="text-xs text-gray-600 leading-relaxed line-clamp-2">
                            {{ reservation.descripcionCompleta }}
                          </p>
                        </div>

                        <!-- Progress Info -->
                        <div class="grid grid-cols-2 gap-3">
                          <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-center">
                            <div class="text-xl font-bold text-blue-600">
                              {{ reservation.reservasGeneradas }}
                            </div>
                            <div class="text-xs text-blue-500 font-medium">Generadas</div>
                          </div>
                          
                          <div class="bg-green-50 p-3 rounded-lg border border-green-100 text-center">
                            <div class="text-xl font-bold text-green-600">
                              {{ reservation.maxReservas || '∞' }}
                            </div>
                            <div class="text-xs text-green-500 font-medium">Máximo</div>
                          </div>
                        </div>

                        <!-- Next Dates -->
                        @if (reservation.proximasFechas && reservation.proximasFechas.length > 0) {
                          <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Próximas fechas:</h4>
                            <div class="space-y-1 max-h-20 overflow-y-auto">
                              @for (fecha of reservation.proximasFechas.slice(0, 3); track fecha) {
                                <div class="flex items-center gap-2 text-xs">
                                  <i class="pi pi-calendar text-gray-400 text-xs"></i>
                                  <span class="text-gray-600">{{ fecha | date:'dd/MM/yyyy' }}</span>
                                </div>
                              }
                              @if (reservation.proximasFechas.length > 3) {
                                <div class="text-xs text-gray-500 italic">
                                  ...y {{ reservation.proximasFechas.length - 3 }} más
                                </div>
                              }
                            </div>
                          </div>
                        }

                        <!-- Observaciones -->
                        @if (reservation.observaciones) {
                          <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-1">Observaciones:</h4>
                            <p class="text-xs text-gray-600 line-clamp-2">{{ reservation.observaciones }}</p>
                          </div>
                        }
                      </div>

                      <!-- Footer -->
                      <div class="px-4 py-3 bg-gray-50 border-t border-gray-100">
                        <div class="flex justify-between items-center text-xs text-gray-500">
                          <span>Creada: {{ reservation.fechaCreacion | date:'dd/MM/yyyy' }}</span>
                          @if (reservation.proximaFechaGeneracion) {
                            <span class="text-usco-vino-600 font-medium">Próxima: {{ reservation.proximaFechaGeneracion | date:'dd/MM/yyyy' }}</span>
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          </ng-template>

          <ng-template #emptymessage>
            <div class="text-center py-8">
              <p class="text-gray-500">No se encontraron reservas recurrentes</p>
            </div>
          </ng-template>
        </p-dataView>
        
        <!-- Menu global para todas las reservas -->
        <p-menu 
          #globalMenu 
          [model]="currentMenuItems" 
          [popup]="true"
          appendTo="body">
        </p-menu>
      </div>
    }
    
    <!-- Modal de Detalles -->
    <p-dialog 
      [header]="'Detalles de Reserva Recurrente'"
      [modal]="true"
      [visible]="showDetailsModal()"
      (onHide)="closeDetailsModal()"
      [draggable]="false"
      [resizable]="false"
      [closable]="false"
      styleClass="w-[90vw] md:w-[70vw] lg:w-[60vw] xl:w-[50vw]">
      
      @if (selectedReservation()) {
        <div class="space-y-6">
          <!-- Header Information -->
          <div class="bg-gradient-to-r from-usco-vino-50 to-usco-ocre-50 p-4 rounded-lg border border-usco-vino-200">
            <div class="flex justify-between items-start mb-3">
              <h3 class="text-xl font-bold text-usco-vino-700">
                {{ selectedReservation()?.escenarioNombre }}
              </h3>
              <div class="flex gap-2">
                <p-tag 
                  [value]="selectedReservation()?.activa ? 'Activa' : 'Inactiva'"
                  [severity]="selectedReservation()?.activa ? 'success' : 'warning'"
                  [rounded]="true">
                </p-tag>
                @if (!selectedReservation()?.puedeGenerarMas) {
                  <p-tag 
                    value="Completada"
                    severity="info"
                    [rounded]="true">
                  </p-tag>
                }
              </div>
            </div>
            <div class="text-sm text-usco-vino-600">
              <i class="pi pi-map-marker mr-2"></i>
              ID del Escenario: {{ selectedReservation()?.escenarioId }}
            </div>
          </div>

          <!-- Pattern Information -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-4">
              <div>
                <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                  <i class="pi pi-refresh text-usco-vino-500 mr-2"></i>
                  Patrón de Recurrencia
                </h4>
                <div class="bg-gray-50 p-3 rounded-lg">
                  <div class="font-medium text-usco-vino-600 mb-1">
                    {{ getPatronLabel(selectedReservation()?.patron!) }}
                  </div>
                  <div class="text-sm text-gray-600">
                    {{ selectedReservation()?.descripcionCompleta }}
                  </div>
                </div>
              </div>

              <div>
                <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                  <i class="pi pi-calendar text-usco-vino-500 mr-2"></i>
                  Fechas y Horarios
                </h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Fecha inicio:</span>
                    <span class="font-medium">{{ selectedReservation()?.fechaInicio | date:'dd/MM/yyyy' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Fecha fin:</span>
                    <span class="font-medium">{{ selectedReservation()?.fechaFin | date:'dd/MM/yyyy' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Horario:</span>
                    <span class="font-medium">{{ selectedReservation()?.horaInicio }} - {{ selectedReservation()?.horaFin }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="space-y-4">
              <div>
                <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                  <i class="pi pi-chart-bar text-usco-vino-500 mr-2"></i>
                  Estadísticas
                </h4>
                <div class="grid grid-cols-2 gap-3">
                  <div class="bg-blue-50 p-3 rounded-lg text-center border border-blue-200">
                    <div class="text-2xl font-bold text-blue-600">
                      {{ selectedReservation()?.reservasGeneradas }}
                    </div>
                    <div class="text-xs text-blue-500 font-medium">Generadas</div>
                  </div>
                  <div class="bg-green-50 p-3 rounded-lg text-center border border-green-200">
                    <div class="text-2xl font-bold text-green-600">
                      {{ selectedReservation()?.maxReservas || '∞' }}
                    </div>
                    <div class="text-xs text-green-500 font-medium">Máximo</div>
                  </div>
                </div>
              </div>

              <div>
                <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                  <i class="pi pi-user text-usco-vino-500 mr-2"></i>
                  Información del Usuario
                </h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Nombre:</span>
                    <span class="font-medium">{{ selectedReservation()?.usuarioNombre }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Email:</span>
                    <span class="font-medium">{{ selectedReservation()?.usuarioEmail }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Next Dates -->
          @if (selectedReservation()?.proximasFechas && selectedReservation()?.proximasFechas!.length > 0) {
            <div>
              <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                <i class="pi pi-calendar-plus text-usco-vino-500 mr-2"></i>
                Próximas Fechas de Reserva
              </h4>
              <div class="bg-gray-50 p-4 rounded-lg max-h-32 overflow-y-auto">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                  @for (fecha of selectedReservation()?.proximasFechas; track fecha) {
                    <div class="bg-white p-2 rounded border text-center text-sm">
                      <i class="pi pi-calendar text-xs text-gray-400 mr-1"></i>
                      {{ fecha | date:'dd/MM/yyyy' }}
                    </div>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Observaciones -->
          @if (selectedReservation()?.observaciones) {
            <div>
              <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                <i class="pi pi-comment text-usco-vino-500 mr-2"></i>
                Observaciones
              </h4>
              <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm text-gray-700">{{ selectedReservation()?.observaciones }}</p>
              </div>
            </div>
          }

          <!-- Audit Information -->
          <div class="border-t pt-4">
            <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
              <i class="pi pi-info-circle text-usco-vino-500 mr-2"></i>
              Información de Auditoría
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
              <div>
                <div class="flex justify-between mb-1">
                  <span>Creado por:</span>
                  <span class="font-medium">{{ selectedReservation()?.creadoPor }}</span>
                </div>
                <div class="flex justify-between">
                  <span>Fecha creación:</span>
                  <span class="font-medium">{{ selectedReservation()?.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
              </div>
              <div>
                @if (selectedReservation()?.actualizadoPor) {
                  <div class="flex justify-between mb-1">
                    <span>Actualizado por:</span>
                    <span class="font-medium">{{ selectedReservation()?.actualizadoPor }}</span>
                  </div>
                }
                <div class="flex justify-between">
                  <span>Última actualización:</span>
                  <span class="font-medium">{{ selectedReservation()?.fechaActualizacion | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      }
      
      <ng-template #footer>
        <div class="flex justify-end gap-2">
          <p-button 
            label="Cerrar"
            icon="pi pi-times"
            severity="secondary"
            (onClick)="closeDetailsModal()">
          </p-button>
          @if (selectedReservation()?.activa) {
            <p-button 
              label="Editar"
              icon="pi pi-pencil"
              (onClick)="editReservation(selectedReservation()!); closeDetailsModal()">
            </p-button>
          }
        </div>
      </ng-template>
    </p-dialog>
    
    <!-- Modal de Edición -->
    <p-dialog 
      [header]="'Editar Reserva Recurrente'"
      [modal]="true"
      [visible]="showEditModal()"
      (onHide)="closeEditModal()"
      [draggable]="false"
      [resizable]="false"
      [closable]="false"
      styleClass="w-[90vw] md:w-[60vw] lg:w-[50vw]">
      
      @if (selectedReservation()) {
        <form [formGroup]="editForm" (ngSubmit)="saveChanges()">
          <div class="space-y-6">
            <!-- Información no editable -->
            <div class="bg-gray-50 p-4 rounded-lg border">
              <h4 class="font-semibold text-gray-800 mb-3">Información de la Reserva</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                  <span class="text-gray-600">Escenario:</span>
                  <span class="font-medium ml-2">{{ selectedReservation()?.escenarioNombre }}</span>
                </div>
                <div>
                  <span class="text-gray-600">Patrón:</span>
                  <span class="font-medium ml-2">{{ getPatronLabel(selectedReservation()?.patron!) }}</span>
                </div>
                <div>
                  <span class="text-gray-600">Fecha inicio:</span>
                  <span class="font-medium ml-2">{{ selectedReservation()?.fechaInicio | date:'dd/MM/yyyy' }}</span>
                </div>
                <div>
                  <span class="text-gray-600">Horario:</span>
                  <span class="font-medium ml-2">{{ selectedReservation()?.horaInicio }} - {{ selectedReservation()?.horaFin }}</span>
                </div>
              </div>
            </div>

            <!-- Campos editables -->
            <div class="space-y-4">
              <h4 class="font-semibold text-gray-800">Campos Editables</h4>
              
              <!-- Fecha Fin -->
              <p-floatlabel>
                <p-datepicker 
                  id="fechaFin"
                  formControlName="fechaFin"
                  [showIcon]="true"
                  [minDate]="getMinDate()"
                  dateFormat="dd/mm/yy"
                  class="w-full">
                </p-datepicker>
                <label for="fechaFin">Fecha de Finalización *</label>
              </p-floatlabel>
              @if (editForm.get('fechaFin')?.invalid && editForm.get('fechaFin')?.touched) {
                <small class="text-red-500">La fecha de finalización es requerida</small>
              }

              <!-- Máximo de Reservas -->
              <p-floatlabel>
                <p-inputnumber 
                  id="maxReservas"
                  formControlName="maxReservas"
                  [min]="selectedReservation()?.reservasGeneradas || 0"
                  [max]="1000"
                  [allowEmpty]="true"
                  placeholder="Sin límite"
                  class="w-full">
                </p-inputnumber>
                <label for="maxReservas">Máximo de Reservas</label>
              </p-floatlabel>
              <small class="text-gray-500">
                Reservas ya generadas: {{ selectedReservation()?.reservasGeneradas }}. 
                Deje vacío para ilimitado.
              </small>

              <!-- Observaciones -->
              <p-floatlabel>
                <textarea 
                  pTextarea
                  id="observaciones"
                  formControlName="observaciones"
                  rows="3"
                  class="w-full">
                </textarea>
                <label for="observaciones">Observaciones</label>
              </p-floatlabel>
            </div>

            <!-- Warning sobre cambios -->
            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
              <div class="flex items-start">
                <i class="pi pi-exclamation-triangle text-yellow-600 mr-2 mt-1"></i>
                <div class="text-sm">
                  <p class="font-medium text-yellow-800 mb-1">Importante:</p>
                  <ul class="text-yellow-700 space-y-1">
                    <li>• Los cambios solo afectarán las reservas futuras que se generen</li>
                    <li>• Las reservas ya generadas no se modificarán</li>
                    <li>• La fecha de finalización debe ser posterior a la fecha de inicio</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </form>
      }
      
      <ng-template #footer>
        <div class="flex justify-end gap-2">
          <p-button 
            label="Cancelar"
            icon="pi pi-times"
            severity="secondary"
            [disabled]="saving()"
            (onClick)="closeEditModal()">
          </p-button>
          <p-button 
            label="Guardar Cambios"
            icon="pi pi-save"
            [disabled]="editForm.invalid || saving()"
            [loading]="saving()"
            (onClick)="saveChanges()">
          </p-button>
        </div>
      </ng-template>
    </p-dialog>
  </div>
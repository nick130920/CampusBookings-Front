<div class="container mx-auto p-6">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-usco-vino-500 mb-2">Mis Reservas Recurrentes</h1>
        <p class="text-usco-gris-600">Gestione sus configuraciones de reservas automáticas</p>
      </div>
      
      <p-button 
        label="Nueva Reserva Recurrente"
        icon="pi pi-plus"
        routerLink="/dashboard/reservas/recurrente">
      </p-button>
    </div>

    <!-- Loading State -->
    @if (loading()) {
      <div class="text-center py-12">
        <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}"></p-progressSpinner>
        <p class="mt-4 text-usco-gris-600">Cargando reservas recurrentes...</p>
      </div>
    }

    <!-- Empty State -->
    @if (!loading() && reservations().length === 0) {
      <p-card class="shadow-usco border-0">
        <div class="text-center py-12">
          <i class="pi pi-calendar text-6xl text-usco-gris-300 mb-4 block"></i>
          <h3 class="text-xl font-semibold text-usco-gris-700 mb-2">No tienes reservas recurrentes</h3>
          <p class="text-usco-gris-500 mb-6">Crea tu primera reserva recurrente para automatizar tus reservas.</p>
          <p-button 
            label="Crear Primera Reserva Recurrente"
            icon="pi pi-plus"
            routerLink="/dashboard/reservas/recurrente">
          </p-button>
        </div>
      </p-card>
    }

    <!-- Reservations List -->
    @if (!loading() && reservations().length > 0) {
      <p-dataView 
        [value]="reservations()" 
        layout="grid"
        [paginator]="true"
        [rows]="6"
        [rowsPerPageOptions]="[6, 12, 18]">
        
        <ng-template pTemplate="grid" let-reservation>
          <div class="col-12 md:col-6 lg:col-4 mb-4">
            <p-card 
              class="h-full border border-usco-gris-200 shadow-usco hover:shadow-usco-lg transition-all duration-200 hover:-translate-y-1 bg-white rounded-xl">
              
              <!-- Header with status and actions -->
              <ng-template pTemplate="header">
                <div class="flex justify-between items-start p-4 pb-2">
                  <div class="flex items-center gap-2">
                    <p-tag 
                      [value]="reservation.activa ? 'Activa' : 'Inactiva'"
                      [severity]="reservation.activa ? 'success' : 'warning'"
                      [class]="reservation.activa ? 'bg-green-100 text-green-800 border-green-200' : 'bg-usco-ocre-100 text-usco-ocre-700 border-usco-ocre-200'"
                      [rounded]="true">
                    </p-tag>
                    
                    @if (!reservation.puedeGenerarMas) {
                      <p-tag 
                        value="Completada"
                        severity="info"
                        class="bg-blue-100 text-blue-800 border-blue-200"
                        [rounded]="true">
                      </p-tag>
                    }
                  </div>
                  
                  <p-menu 
                    #menu 
                    [model]="getMenuItems(reservation)" 
                    [popup]="true">
                  </p-menu>
                  <p-button 
                    icon="pi pi-ellipsis-v"
                    [text]="true"
                    [rounded]="true"
                    size="small"
                    class="text-usco-gris-500 hover:text-usco-vino-600 hover:bg-usco-vino-50 transition-colors duration-200"
                    (onClick)="menu.toggle($event)">
                  </p-button>
                </div>
              </ng-template>

              <!-- Content -->
              <div class="space-y-4">
                <!-- Escenario Info -->
                <div>
                  <h3 class="font-semibold text-lg text-usco-gris-800 mb-1">
                    {{ reservation.escenarioNombre }}
                  </h3>
                  <div class="flex items-center gap-2 text-sm text-usco-gris-500">
                    <i class="pi pi-map-marker"></i>
                    <span>ID: {{ reservation.escenarioId }}</span>
                  </div>
                </div>

                <!-- Pattern Description -->
                <div class="bg-usco-gris-50 p-3 rounded-lg border border-usco-gris-100">
                  <div class="flex items-center gap-2 mb-2">
                    <i class="pi pi-refresh text-usco-vino-500"></i>
                    <span class="font-medium text-sm text-usco-gris-700">{{ getPatronLabel(reservation.patron) }}</span>
                  </div>
                  <p class="text-xs text-usco-gris-600 leading-relaxed">
                    {{ reservation.descripcionCompleta }}
                  </p>
                </div>

                <!-- Progress Info -->
                <div class="grid grid-cols-2 gap-4 text-center">
                  <div class="bg-blue-50 p-2 rounded border border-blue-100">
                    <div class="text-lg font-bold text-blue-600">
                      {{ reservation.reservasGeneradas }}
                    </div>
                    <div class="text-xs text-blue-500">Generadas</div>
                  </div>
                  
                  <div class="bg-green-50 p-2 rounded border border-green-100">
                    <div class="text-lg font-bold text-green-600">
                      {{ reservation.maxReservas || '∞' }}
                    </div>
                    <div class="text-xs text-green-500">Máximo</div>
                  </div>
                </div>

                <!-- Next Dates -->
                @if (reservation.proximasFechas && reservation.proximasFechas.length > 0) {
                  <div>
                    <h4 class="text-sm font-medium text-usco-gris-700 mb-2">Próximas fechas:</h4>
                    <div class="space-y-1">
                      @for (fecha of reservation.proximasFechas.slice(0, 3); track fecha) {
                        <div class="flex items-center gap-2 text-xs">
                          <i class="pi pi-calendar text-usco-gris-400"></i>
                          <span class="text-usco-gris-600">{{ fecha | date:'dd/MM/yyyy' }}</span>
                        </div>
                      }
                      @if (reservation.proximasFechas.length > 3) {
                        <div class="text-xs text-usco-gris-500">
                          ...y {{ reservation.proximasFechas.length - 3 }} más
                        </div>
                      }
                    </div>
                  </div>
                }

                <!-- Observaciones -->
                @if (reservation.observaciones) {
                  <div>
                    <h4 class="text-sm font-medium text-usco-gris-700 mb-1">Observaciones:</h4>
                    <p class="text-xs text-usco-gris-600">{{ reservation.observaciones }}</p>
                  </div>
                }
              </div>

              <!-- Footer -->
              <ng-template pTemplate="footer">
                <div class="flex justify-between items-center text-xs text-usco-gris-500 pt-2 border-t border-usco-gris-100 mt-4">
                  <span>Creada: {{ reservation.fechaCreacion | date:'dd/MM/yyyy' }}</span>
                  @if (reservation.proximaFechaGeneracion) {
                    <span>Próxima: {{ reservation.proximaFechaGeneracion | date:'dd/MM/yyyy' }}</span>
                  }
                </div>
              </ng-template>
            </p-card>
          </div>
        </ng-template>

        <ng-template pTemplate="empty">
          <div class="text-center py-8">
            <p class="text-usco-gris-500">No se encontraron reservas recurrentes</p>
          </div>
        </ng-template>
      </p-dataView>
    }
  </div>
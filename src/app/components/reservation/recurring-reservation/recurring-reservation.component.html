<div class="container mx-auto p-6 max-w-4xl">
  <p-toast></p-toast>
  
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-usco-vino-500 mb-2">Reservas Recurrentes</h1>
    <p class="text-usco-gris-600">Configure reservas que se repiten automáticamente según un patrón específico</p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Formulario de Configuración -->
    <div class="space-y-6">
      <p-card header="Configuración de Reserva Recurrente" 
              class="usco-card-primary">
        <form [formGroup]="reservaForm" (ngSubmit)="onPreview()" class="space-y-4">
          
          <!-- Escenario -->
          <div>
            <label class="block text-sm font-medium text-surface-700 mb-2">
              Escenario <span class="text-danger-500">*</span>
            </label>
            <p-select 
              formControlName="escenarioId"
              [options]="scenarios()"
              optionLabel="nombre"
              optionValue="id"
              placeholder="Seleccione un escenario"
              [loading]="loadingScenarios()"
              class="w-full"
              [style]="{'width': '100%'}"
              appendTo="body">
              <ng-template pTemplate="selectedItem" let-selectedOption>
                <div class="flex items-center gap-2" *ngIf="selectedOption">
                  <span class="font-medium">{{ selectedOption.nombre }}</span>
                  <span class="text-xs text-gray-500">{{ selectedOption.tipo }}</span>
                </div>
              </ng-template>
              <ng-template pTemplate="item" let-scenario>
                <div class="flex flex-col gap-1 p-2">
                  <span class="font-medium">{{ scenario.nombre }}</span>
                  <div class="flex gap-2 text-xs text-gray-500">
                    <span>{{ scenario.tipo }}</span>
                    <span>•</span>
                    <span>{{ scenario.ubicacion }}</span>
                    <span>•</span>
                    <span>Capacidad: {{ scenario.capacidad }}</span>
                  </div>
                </div>
              </ng-template>
            </p-select>
          </div>

          <!-- Patrón de Recurrencia -->
          <div>
            <label class="block text-sm font-medium text-surface-700 mb-2">
              Patrón de Recurrencia <span class="text-danger-500">*</span>
            </label>
            <p-select 
              formControlName="patron"
              [options]="patronOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Seleccione el patrón de repetición"
              class="w-full"
              [style]="{'width': '100%'}"
              appendTo="body">
            </p-select>
          </div>

          <!-- Configuración específica del patrón -->
          @if (selectedPatron() === 'SEMANAL') {
            <div>
              <label class="block text-sm font-medium text-surface-700 mb-2">
                Días de la Semana <span class="text-danger-500">*</span>
              </label>
              <div class="grid grid-cols-7 gap-2">
                @for (dia of DIAS_SEMANA; track dia.value) {
                  <div class="flex items-center">
                    <p-checkbox 
                      [value]="dia.value"
                      [(ngModel)]="selectedDays"
                      [ngModelOptions]="{standalone: true}"
                      [inputId]="'dia-' + dia.value"
                      class="text-center">
                    </p-checkbox>
                    <label [for]="'dia-' + dia.value" class="ml-1 text-xs font-medium cursor-pointer">
                      {{ dia.abrev }}
                    </label>
                  </div>
                }
              </div>
            </div>
          }

          @if (selectedPatron() === 'MENSUAL') {
            <div>
              <label class="block text-sm font-medium text-surface-700 mb-2">
                Día del Mes <span class="text-danger-500">*</span>
              </label>
              <p-inputNumber 
                formControlName="diaMes"
                [min]="1"
                [max]="31"
                placeholder="Día del mes (1-31)"
                class="w-full">
              </p-inputNumber>
            </div>
          }

          <!-- Intervalo de Repetición -->
          <div>
            <label class="block text-sm font-medium text-surface-700 mb-2">
              Intervalo de Repetición
            </label>
            <p-inputNumber 
              formControlName="intervaloRepeticion"
              [min]="1"
              [max]="52"
              placeholder="Cada X {{ getIntervaloLabel() }}"
              class="w-full">
            </p-inputNumber>
            <small class="text-surface-500">
              Repetir cada {{ reservaForm.get('intervaloRepeticion')?.value || 1 }} {{ getIntervaloLabel() }}
            </small>
          </div>

          <!-- Rango de Fechas -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-surface-700 mb-2">
                Fecha de Inicio <span class="text-danger-500">*</span>
              </label>
              <p-datepicker 
                formControlName="fechaInicio"
                [minDate]="minDate"
                [maxDate]="maxDate"
                placeholder="dd/mm/yyyy"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                inputId="fechaInicio"
                class="w-full"
                appendTo="body">
              </p-datepicker>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-surface-700 mb-2">
                Fecha de Fin <span class="text-danger-500">*</span>
              </label>
              <p-datepicker 
                formControlName="fechaFin"
                [minDate]="minDateFin()"
                [maxDate]="maxDate"
                placeholder="dd/mm/yyyy"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                inputId="fechaFin"
                class="w-full"
                appendTo="body">
              </p-datepicker>
            </div>
          </div>

          <!-- Horarios -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-surface-700 mb-2">
                Hora de Inicio <span class="text-danger-500">*</span>
              </label>
              <p-datepicker 
                formControlName="horaInicio"
                [timeOnly]="true"
                placeholder="HH:MM"
                [showIcon]="true"
                inputId="horaInicio"
                class="w-full"
                appendTo="body">
              </p-datepicker>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-surface-700 mb-2">
                Hora de Fin <span class="text-danger-500">*</span>
              </label>
              <p-datepicker 
                formControlName="horaFin"
                [timeOnly]="true"
                placeholder="HH:MM"
                [showIcon]="true"
                inputId="horaFin"
                class="w-full"
                appendTo="body">
              </p-datepicker>
            </div>
          </div>

          <!-- Límite de Reservas -->
          <div>
            <label class="block text-sm font-medium text-surface-700 mb-2">
              Límite Máximo de Reservas
            </label>
            <p-inputNumber 
              formControlName="maxReservas"
              [min]="1"
              [max]="365"
              placeholder="Máximo de reservas a generar"
              class="w-full">
            </p-inputNumber>
            <small class="text-surface-500">
              Opcional. Por defecto se generarán hasta 52 reservas.
            </small>
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-surface-700 mb-2">
              Observaciones
            </label>
            <p-textarea 
              formControlName="observaciones"
              placeholder="Observaciones adicionales..."
              rows="3"
              class="w-full">
            </p-textarea>
          </div>

          <!-- Botones -->
          <div class="flex gap-3 pt-4">
            <p-button 
              label="Previsualizar"
              icon="pi pi-eye"
              [loading]="loadingPreview()"
              type="submit"
              [disabled]="!reservaForm.valid"
              severity="secondary"
              [outlined]="true">
            </p-button>
            
            <p-button 
              label="Crear Reserva Recurrente"
              icon="pi pi-plus"
              [loading]="creating()"
              [disabled]="!preview() || !reservaForm.valid"
              (onClick)="onCreate()"
              severity="success">
            </p-button>
          </div>
        </form>
      </p-card>
    </div>

    <!-- Vista Previa -->
    <div class="space-y-6">
      @if (preview(); as previewData) {
        <p-card header="Vista Previa de Reservas" 
                class="usco-card-secondary">
          
          <!-- Resumen -->
          <div class="mb-4">
            <div class="flex items-center gap-2 mb-2">
              <i class="pi pi-calendar text-warn-500"></i>
              <span class="font-medium">{{ previewData.descripcionPatron }}</span>
            </div>
            <div class="text-sm text-surface-600">
              <p>Total de reservas a generar: <span class="font-medium">{{ previewData.totalReservasAGenerar }}</span></p>
            </div>
          </div>

          <!-- Conflictos y Advertencias -->
          @if (previewData.conflictos.length > 0) {
            <div class="mb-4">
              <p-panel header="Conflictos Encontrados" [toggleable]="true" [collapsed]="false">
                <div class="space-y-2">
                  @for (conflicto of previewData.conflictos; track $index) {
                    <div class="flex items-center gap-2 text-sm">
                      <i class="pi pi-exclamation-triangle text-danger-500"></i>
                      <span>{{ conflicto }}</span>
                    </div>
                  }
                </div>
              </p-panel>
            </div>
          }

          @if (previewData.advertencias.length > 0) {
            <div class="mb-4">
              <p-panel header="Advertencias" [toggleable]="true" [collapsed]="true">
                <div class="space-y-2">
                  @for (advertencia of previewData.advertencias; track $index) {
                    <div class="flex items-center gap-2 text-sm">
                      <i class="pi pi-info-circle text-warn-600"></i>
                      <span>{{ advertencia }}</span>
                    </div>
                  }
                </div>
              </p-panel>
            </div>
          }

          <!-- Lista de Fechas -->
          <div>
            <h4 class="font-medium mb-3">Fechas de Reservas (Primeras 10)</h4>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              @for (fecha of previewData.fechasReservas.slice(0, 10); track fecha.fecha) {
                <div class="flex items-center justify-between p-2 border rounded-md"
                      [class.border-red-200]="fecha.tieneConflicto"
                      [class.bg-red-50]="fecha.tieneConflicto"
                      [class.border-gray-200]="!fecha.tieneConflicto">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium">{{ fecha.fecha | date:'dd/MM/yyyy' }}</span>
                    <span class="text-xs text-surface-500">{{ fecha.diaSemana }}</span>
                  </div>
                  @if (fecha.tieneConflicto) {
                    <p-tag severity="danger" value="Conflicto" [rounded]="true"></p-tag>
                  } @else {
                    <p-tag severity="success" value="Disponible" [rounded]="true"></p-tag>
                  }
                </div>
              }
              
              @if (previewData.fechasReservas.length > 10) {
                <div class="text-center text-sm text-surface-500 pt-2">
                  ... y {{ previewData.fechasReservas.length - 10 }} fechas más
                </div>
              }
            </div>
          </div>
        </p-card>
      }

      @if (!preview() && !loadingPreview()) {
        <p-card>
          <div class="text-center text-surface-500 py-8">
            <i class="pi pi-calendar text-4xl mb-4 block"></i>
            <p>Complete el formulario y haga clic en "Previsualizar" para ver las fechas que se generarán</p>
          </div>
        </p-card>
      }

      @if (loadingPreview()) {
        <p-card>
          <div class="text-center py-8">
            <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}"></p-progressSpinner>
            <p class="mt-4 text-surface-600">Generando vista previa...</p>
          </div>
        </p-card>
      }
    </div>
  </div>
</div>